stages:
  - Test
  - Build
  - Deploy

sonarqube-check:
  stage: Test
  image: 
    name: sonarsource/sonar-scanner-cli:5.0
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script: 
    - echo "\nsonar.token=${SONAR_TOKEN}" >> sonar-project.properties
    - sonar-scanner
  allow_failure: false
  only:
    - develop
    - Develop

Build:
  stage: Build
  environment: $CI_COMMIT_BRANCH
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login --username $CI_REGISTRY_USER $CI_REGISTRY --password-stdin
  script:
    - echo $ENV | base64 -d > .env
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_BRANCH  .
    - docker push  $CI_REGISTRY_IMAGE:$CI_COMMIT_BRANCH
  tags:
    - build
  only:
    - Staging
    - Production

Deploy:
  stage: Deploy
  environment: $CI_COMMIT_BRANCH
  before_script:
    - 'command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$DEPLOY_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan "$SERVER_IP" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - export DOCKER_HOST="ssh://$SERVER_USER@$SERVER_IP"
    - echo $CI_REGISTRY_PASSWORD | docker login --username $CI_REGISTRY_USER $CI_REGISTRY --password-stdin
  script:
    - echo $ENV | base64 -d > .env
    - make $CI_COMMIT_BRANCH
    - docker compose -f $CI_COMMIT_BRANCH.yml pull 
    - docker compose -f $CI_COMMIT_BRANCH.yml up -d  --force-recreate
  tags:
    - build
  only: 
    - Staging
    - Production